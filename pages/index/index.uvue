<template>
	<scroll-view class="page" scroll-y="true">
		<view class="nav-header">
			<text class="brand">ZenMatrix</text>
			<view class="avatar-circle" @click="goProfile">
				<text class="avatar-txt">{{ userInitials }}</text>
			</view>
		</view>

		<view class="header-card">
			<text class="card-title">å½“å‰åº“å­˜æ€»è´§å€¼ (æˆæœ¬)</text>
			<view class="card-content">
				<view class="left-part">
					<text class="currency">Â¥</text>
					<text class="amount">{{ formatNum(data['stock_value']) }}</text>
				</view>
				<view class="right-part">
					<view class="mini-box">
						<text class="mini-label">ä»Šæ—¥å…¥åº“</text>
						<text class="mini-val">{{ data['today_entry'] }}</text>
					</view>
					<view class="mini-box">
						<text class="mini-label">ä»Šæ—¥é”€å”®</text>
						<text class="mini-val">{{ data['today_sale'] }}</text>
					</view>
				</view>
			</view>
		</view>

		<view class="grid-box">
			<view class="grid-item" @click="go('/pages/contact/list')"><view class="icon-circle purple"><text class="emoji">ğŸ‘¥</text></view><text class="grid-text">å®¢æˆ·</text></view>
			<view class="grid-item" @click="go('/pages/inventory/list')"><view class="icon-circle orange"><text class="emoji">ğŸ“¦</text></view><text class="grid-text">åº“å­˜</text></view>
			<view class="grid-item" @click="go('/pages/rental/list')"><view class="icon-circle blue"><text class="emoji">ğŸ”„</text></view><text class="grid-text">ç§Ÿèµ</text></view>
			<view class="grid-item" @click="go('/pages/account/list')"><view class="icon-circle indigo"><text class="emoji">ğŸ¦</text></view><text class="grid-text">èµ„é‡‘</text></view>
		</view>

		<view class="row-box">
			<view class="row-item" @click="go('/pages/analysis/profit')"><text class="mini-icon yellow">ğŸ“ˆ</text><view class="text-group"><text class="row-title">åˆ©æ¶¦æŠ¥è¡¨</text><text class="row-desc">æŸ¥çœ‹æ¯›åˆ©</text></view></view>
			<view class="row-item" @click="go('/pages/analysis/finance')"><text class="mini-icon red">ğŸ’°</text><view class="text-group"><text class="row-title">æ¬ æ¬¾å¾€æ¥</text><text class="row-desc">åº”æ”¶åº”ä»˜</text></view></view>
		</view>
		
		<view class="recent-box">
			<text class="section-title">æœ€è¿‘åŠ¨æ€</text>
			<view class="list-container">
				<view v-for="(item, index) in (data['recent_list'] as any[])" :key="index" class="list-item">
					<view class="list-left"><text class="item-desc">{{ item['desc'] }}</text><text class="item-time">{{ item['time'] }}</text></view>
					<text class="item-amount" :class="item['is_income'] ? 'text-red' : 'text-green'">{{ item['is_income'] ? '+' : '-' }} {{ formatNum(item['amount']) }}</text>
				</view>
				<view v-if="(data['recent_list'] as any[]).length == 0" class="empty-tip"><text class="empty-text">æš‚æ— åŠ¨æ€</text></view>
			</view>
		</view>
		<view class="bottom-placeholder"></view>
	</scroll-view>
	<view class="bottom-bar">
		<button class="btn btn-white" @click="go('/pages/entry/add')">ğŸ“¥ å¿«é€Ÿå…¥åº“</button>
		<button class="btn btn-blue" @click="go('/pages/sales/add')">ğŸ’¸ ç«‹å³å¼€å•</button>
	</view>
</template>
<script>
	import { request } from '@/common/api.js';
	export default {
		data() { 
			return { 
				// âš ï¸ æ–°å¢å˜é‡ï¼šé»˜è®¤æ˜¾ç¤º Guestï¼Œç™»å½•åä¼šå˜
				userInitials: 'G',
				data: { stock_value: 0, stock_count: 0, today_entry: 0, today_sale: 0, recent_list: [] } as any 
			} 
		},
		onShow() { 
			this.loadData(); 
			this.updateUser();
		},
		methods: {
			// âš ï¸ æ–°å¢æ–¹æ³•ï¼šæ›´æ–°ç”¨æˆ·å¤´åƒæ–‡å­—
			updateUser() {
				let name = uni.getStorageSync('username') as string;
				if (name) {
					// å–å‰ä¸¤ä¸ªå­—ç¬¦å¹¶å¤§å†™ï¼Œä¾‹å¦‚ admin -> AD
					this.userInitials = name.substring(0, 2).toUpperCase();
				}
			},
			async loadData() { try { const res = await request({ url: '/api/analysis/dashboard/' }); if(res != null) this.data = res; } catch(e){} },
			formatNum(num: any | null): string { if (num == null) return "0.00"; let val = parseFloat(JSON.stringify(num)); return val.toFixed(2); },
			go(url: string) { uni.navigateTo({ url: url, fail: () => { uni.showToast({ title: 'è·¯å¾„æœªé…ç½®', icon: 'none' }); } }); },
			goProfile() { uni.navigateTo({ url: '/pages/profile/index' }); }
		}
	}
</script>
<style>
	.page { background-color: #f8faff; flex: 1; padding: 0 30rpx; }
	.nav-header { flex-direction: row; justify-content: space-between; align-items: center; margin-top: 20rpx; margin-bottom: 20rpx; }
	.brand { font-size: 40rpx; font-weight: 900; color: #1e293b; letter-spacing: -1rpx; }
	.avatar-circle { width: 70rpx; height: 70rpx; border-radius: 35rpx; background-color: #eff6ff; align-items: center; justify-content: center; }
	.avatar-txt { color: #2563eb; font-weight: bold; font-size: 28rpx; }
	.header-card { background-image: linear-gradient(135deg, #2563eb, #3b82f6); border-radius: 32rpx; padding: 40rpx; margin: 20rpx 0 30rpx 0; box-shadow: 0 12rpx 30rpx rgba(37, 99, 235, 0.25); }
	.card-title { font-size: 24rpx; color: #e0e7ff; font-weight: bold; margin-bottom: 24rpx; }
	.card-content { flex-direction: row; justify-content: space-between; align-items: flex-end; }
	.left-part { flex-direction: row; align-items: baseline; }
	.currency { font-size: 32rpx; color: #fff; margin-right: 8rpx; font-weight: bold; }
	.amount { font-size: 64rpx; color: #fff; font-weight: 900; }
	.right-part { flex-direction: row; }
	.mini-box { background-color: rgba(255,255,255,0.12); border-radius: 16rpx; padding: 12rpx 20rpx; align-items: center; margin-left: 16rpx; min-width: 110rpx; }
	.mini-label { font-size: 20rpx; color: #e0e7ff; margin-bottom: 6rpx; }
	.mini-val { font-size: 32rpx; color: #fff; font-weight: bold; }
	.grid-box { flex-direction: row; justify-content: space-between; margin-bottom: 30rpx; }
	.grid-item { width: 160rpx; background-color: #fff; border-radius: 24rpx; padding: 24rpx 0; align-items: center; justify-content: center; box-shadow: 0 4rpx 12rpx rgba(0,0,0,0.03); }
	.icon-circle { width: 88rpx; height: 88rpx; border-radius: 44rpx; align-items: center; justify-content: center; margin-bottom: 12rpx; }
	.purple { background-color: #f3e8ff; } .orange { background-color: #ffedd5; } .blue { background-color: #dbeafe; } .indigo { background-color: #e0e7ff; }
	.emoji { font-size: 40rpx; }
	.grid-text { font-size: 26rpx; font-weight: bold; color: #475569; }
	.row-box { flex-direction: row; justify-content: space-between; margin-bottom: 40rpx; }
	.row-item { width: 335rpx; background-color: #fff; padding: 30rpx 24rpx; border-radius: 24rpx; flex-direction: row; align-items: center; box-shadow: 0 4rpx 12rpx rgba(0,0,0,0.03); }
	.mini-icon { width: 80rpx; height: 80rpx; border-radius: 20rpx; text-align: center; line-height: 80rpx; font-size: 36rpx; margin-right: 20rpx; }
	.yellow { background-color: #fef9c3; color: #ca8a04; } .red { background-color: #fee2e2; color: #dc2626; }
	.text-group { flex-direction: column; }
	.row-title { font-size: 30rpx; font-weight: bold; color: #333; margin-bottom: 4rpx; }
	.row-desc { font-size: 22rpx; color: #94a3b8; }
	.recent-box { margin-bottom: 30rpx; }
	.section-title { font-size: 28rpx; font-weight: bold; color: #64748b; margin-left: 10rpx; margin-bottom: 20rpx; }
	.list-container { background-color: #fff; border-radius: 24rpx; padding: 0 24rpx; box-shadow: 0 4rpx 12rpx rgba(0,0,0,0.03); }
	.list-item { flex-direction: row; justify-content: space-between; align-items: center; padding: 30rpx 0; border-bottom-width: 1px; border-bottom-color: #f1f5f9; border-bottom-style: solid; }
	.list-left { flex-direction: column; width: 65%; }
	.item-desc { font-size: 30rpx; font-weight: bold; color: #333; margin-bottom: 8rpx; lines: 1; text-overflow: ellipsis; }
	.item-time { font-size: 22rpx; color: #94a3b8; }
	.item-amount { font-size: 30rpx; font-weight: bold; font-family: monospace; }
	.text-red { color: #ef4444; } .text-green { color: #10b981; }
	.empty-tip { padding: 50rpx; align-items: center; } .empty-text { font-size: 26rpx; color: #cbd5e1; }
	.bottom-placeholder { height: 160rpx; }
	.bottom-bar { position: fixed; bottom: 40rpx; left: 30rpx; right: 30rpx; background-color: #fff; padding: 16rpx; border-radius: 30rpx; flex-direction: row; justify-content: space-between; box-shadow: 0 10rpx 40rpx rgba(0,0,0,0.1); }
	.btn { flex: 1; height: 96rpx; line-height: 96rpx; text-align: center; border-radius: 20rpx; font-size: 32rpx; font-weight: bold; border-width: 0; margin: 0 10rpx; }
	.btn-white { background-color: #f1f5f9; color: #475569; }
	.btn-blue { background-color: #2563eb; color: #fff; box-shadow: 0 6rpx 16rpx rgba(37,99,235,0.3); }
</style>